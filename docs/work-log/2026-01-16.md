# 꼭고 랜딩페이지 작업일지

## 2026-01-16 (목)

### 📋 작업 목표
- 데이터베이스 ID 구조 개선
- 하이브리드 학과 테이블 구조 적용
- 프론트엔드 버그 수정

---

### ✅ 완료된 작업

#### 1. DB 스키마 마이그레이션 (하이브리드 구조)

**변경 전:**
- `departments` 테이블: 학교별로 같은 학과명이 중복 저장
- ID: `text` 타입 (`school_7010271`, `dept_xxx_001` 형식)
- `pre_orders`: `phone`이 Primary Key

**변경 후:**
- `majors` 테이블: 학과 정보 정규화 (중복 제거)
- `school_departments` 테이블: 학교-학과 연결 (M:N 관계)
- `major_traits` 테이블: 학과별 특성 연결
- ID: `bigserial` 타입 (자동 증가 정수)
- `pre_orders`: `id`가 PK, `phone`은 UNIQUE 제약

**관련 파일:**
- `prisma/schema.prisma` - Prisma 스키마 정의
- `prisma/migration_hybrid.sql` - 마이그레이션 SQL
- `prisma/verify_hybrid.sql` - 마이그레이션 검증 쿼리

---

#### 2. API 수정 (`/api/schools`)

**변경 내용:**
- CSV 파일 읽기 → Supabase DB 직접 조회로 변경
- 학과명 검색 로직 개선:
  - 이모지 제거 (💻, 🔋 등)
  - 핵심 키워드 추출 (`소프트웨어과` → `소프트웨어`)
  - 여러 검색어로 순차 시도

**관련 파일:**
- `app/api/schools/route.ts`

---

#### 3. 프론트엔드 버그 수정

**문제:** 테스트 완료 후 새로고침하면 무료 리포트가 자동 언락됨

**원인:** URL에 `?type=I` 파라미터가 있으면 공유 링크로 인식

**해결:**
- `sessionStorage`에 본인 테스트 결과 저장
- 공유 링크에는 `?type=I&shared=true` 형태로 구분

**관련 파일:**
- `app/page.tsx`

---

#### 4. Supabase RLS 설정

**문제:** 마이그레이션 후 테이블 접근 권한 없음 (anon key 사용 시)

**해결:** 모든 테이블 RLS 비활성화

```sql
ALTER TABLE schools DISABLE ROW LEVEL SECURITY;
ALTER TABLE majors DISABLE ROW LEVEL SECURITY;
ALTER TABLE school_departments DISABLE ROW LEVEL SECURITY;
ALTER TABLE traits DISABLE ROW LEVEL SECURITY;
ALTER TABLE major_traits DISABLE ROW LEVEL SECURITY;
ALTER TABLE pre_orders DISABLE ROW LEVEL SECURITY;
ALTER TABLE admission_rules DISABLE ROW LEVEL SECURITY;
ALTER TABLE target_companies DISABLE ROW LEVEL SECURITY;
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE user_traits DISABLE ROW LEVEL SECURITY;
```

---

### 🐛 발생한 이슈 및 해결

| 이슈 | 원인 | 해결 |
|------|------|------|
| `cannot drop constraint schools_pkey` | FK 의존성 | `DROP ... CASCADE` 사용 |
| `column already exists` | 중복 rename 시도 | 조건부 ALTER 문으로 수정 |
| 학교명 안 보임 | Supabase RLS 활성화 | RLS 비활성화 |
| 사전예약 저장 오류 | pre_orders RLS 활성화 | RLS 비활성화 |
| 새로고침 시 자동 언락 | 공유링크 인식 오류 | sessionStorage + shared 파라미터 |

---

### 📁 변경된 파일 목록

```
prisma/
├── schema.prisma (수정)
├── migration_hybrid.sql (신규)
├── verify_hybrid.sql (신규)
└── (삭제: migration.sql, verify_migration.sql)

app/
├── page.tsx (수정)
└── api/schools/route.ts (수정)

scripts/
├── seed_schools.js (수정)
└── seed_meister_schools.js (수정)
```

---

### 📝 다음 작업 예정
- [ ] 배포 환경 테스트
- [ ] 취업률/진학률 데이터 DB 이관 (현재 CSV 사용 중)
- [ ] 에러 로깅 정리 (console.log 제거)

---

### 💡 참고사항
- Supabase 테이블 RLS 기본값: 신규 테이블 생성 시 자동으로 활성화됨
- 공개 데이터 테이블은 RLS 비활성화 또는 SELECT 정책 추가 필요

